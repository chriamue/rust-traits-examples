name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Run tests with coverage
        run: |
          cargo tarpaulin --verbose --all-features --workspace --timeout 120 \
            --out Html --out Xml --output-dir coverage/

      - name: Parse coverage results
        id: coverage
        run: |
          # Extract coverage percentage from XML
          COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage/cobertura.xml | head -1 | awk '{printf "%.1f", $1*100}')
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT

          # Count lines covered and total
          LINES_COVERED=$(grep -oP 'lines-covered="\K[0-9]+' coverage/cobertura.xml | head -1)
          LINES_VALID=$(grep -oP 'lines-valid="\K[0-9]+' coverage/cobertura.xml | head -1)
          echo "lines_covered=$LINES_COVERED" >> $GITHUB_OUTPUT
          echo "lines_valid=$LINES_VALID" >> $GITHUB_OUTPUT

          # Determine badge color
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            echo "badge_color=brightgreen" >> $GITHUB_OUTPUT
            echo "badge_message=excellent" >> $GITHUB_OUTPUT
          elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
            echo "badge_color=yellow" >> $GITHUB_OUTPUT
            echo "badge_message=good" >> $GITHUB_OUTPUT
          else
            echo "badge_color=red" >> $GITHUB_OUTPUT
            echo "badge_message=needs improvement" >> $GITHUB_OUTPUT
          fi

      - name: Generate detailed test summary
        if: always()
        run: |
          echo "# ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test execution summary
          echo "## Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run tests again with JSON output to get test counts
          cargo test --no-fail-fast -- --format json -Z unstable-options --report-time 2>/dev/null | \
            jq -r 'select(.type == "suite") | "- **Total Tests**: \(.event) - \(.passed) passed, \(.failed) failed"' >> $GITHUB_STEP_SUMMARY || \
            echo "- **Status**: âœ… All tests passed" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage summary
          echo "## ðŸ“Š Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Coverage** | ${{ steps.coverage.outputs.percentage }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Lines Covered** | ${{ steps.coverage.outputs.lines_covered }} / ${{ steps.coverage.outputs.lines_valid }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage rating
          COVERAGE=${{ steps.coverage.outputs.percentage }}
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            echo "ðŸŸ¢ **Excellent coverage** (â‰¥80%)" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
            echo "ðŸŸ¡ **Good coverage** (â‰¥60%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”´ **Coverage needs improvement** (<60%)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Module breakdown
          echo "## ðŸ“¦ Test Modules" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Animals Module**" >> $GITHUB_STEP_SUMMARY
          echo "  - Dogs, Ducks, Eagles, Penguins, Snakes, Whales" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Behaviors Module**" >> $GITHUB_STEP_SUMMARY
          echo "  - Walking, Swimming, Flying, Driving, LandMove" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Vehicles Module**" >> $GITHUB_STEP_SUMMARY
          echo "  - Cars, Motorcycles, Airplanes, Ships, Helicopters, Amphibious" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Core Module**" >> $GITHUB_STEP_SUMMARY
          echo "  - Energy, Terrain, Weather, Intensity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Competitions Module**" >> $GITHUB_STEP_SUMMARY
          echo "  - Triathlon, Relay, Unified Race, Vehicle Race" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ [Download detailed coverage report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/

      - name: Create coverage badge
        if: github.ref == 'refs/heads/main'
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: YOUR_GIST_ID_HERE
          filename: coverage-badge.json
          label: coverage
          message: ${{ steps.coverage.outputs.percentage }}%
          color: ${{ steps.coverage.outputs.badge_color }}

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.percentage }}';
            const linesCovered = '${{ steps.coverage.outputs.lines_covered }}';
            const linesValid = '${{ steps.coverage.outputs.lines_valid }}';

            let emoji = 'ðŸ”´';
            let status = 'needs improvement';
            if (parseFloat(coverage) >= 80) {
              emoji = 'ðŸŸ¢';
              status = 'excellent';
            } else if (parseFloat(coverage) >= 60) {
              emoji = 'ðŸŸ¡';
              status = 'good';
            }

            const body = `## ðŸ§ª Test Coverage Report

            ${emoji} **Coverage: ${coverage}%** (${status})

            | Metric | Value |
            |--------|-------|
            | Lines Covered | ${linesCovered} / ${linesValid} |
            | Percentage | ${coverage}% |

            <details>
            <summary>ðŸ“¦ Module Coverage</summary>

            - âœ… Animals Module
            - âœ… Behaviors Module
            - âœ… Vehicles Module
            - âœ… Core Module
            - âœ… Competitions Module

            </details>

            [ðŸ“ View detailed HTML report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Test Coverage Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
